<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì°¨ëŸ‰ ìœ„ì¹˜ ì „ì†¡</title>
  <style>
    body { margin:0; font-family:'Malgun Gothic',sans-serif; background:#f5f7fa; display:flex; justify-content:center; align-items:center; min-height:100vh }
    .card { width:92%; max-width:420px; background:#fff; border-radius:24px; padding:24px; box-shadow:0 12px 40px rgba(0,0,0,.08) }
    h2 { text-align:center; margin-bottom:24px; color:#2c3e50 }
    label { display:block; margin-bottom:6px; font-weight:700; font-size:15px }
    input[type=text], input[type=file] { width:100%; padding:14px; margin-bottom:20px; border:1px solid #ddd; border-radius:12px; font-size:16px; box-sizing:border-box }
    .status { padding:14px; border-radius:12px; text-align:center; font-weight:700; margin:12px 0 }
    #trackingStatus { display:none; background:#e74c3c; color:#fff }
    #toggleBtn { width:100%; padding:16px; border:none; border-radius:16px; font-size:18px; font-weight:700; color:#fff; cursor:pointer; background:linear-gradient(135deg,#27ae60,#2ecc71); margin-bottom:12px }
    .media-btn { width:32%; padding:12px; border:none; border-radius:12px; font-size:14px; font-weight:700; color:#fff; cursor:pointer }
    .photo { background:#3498db }
    .file { background:#f39c12 }
    .collapse { background:#bdc3c7; color:#2c3e50 }
    .media-group { display:flex; justify-content:space-between; gap:10px; margin-bottom:20px }
    #adminDelivery { background:#f1f8ff; padding:16px; border-radius:16px; border:1px solid #d1e8ff }
    #adminDelivery img { max-width:100%; border-radius:12px; margin-top:12px }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>
</head>
<body>
  <div class="card">
    <h2>ğŸš— ì°¨ëŸ‰ ìœ„ì¹˜ ì „ì†¡</h2>
    <div id="trackingStatus" class="status">ğŸ“ ìœ„ì¹˜ ì „ì†¡ ì¤‘... (íƒ­ ë‹«ìœ¼ë©´ ì¤‘ë‹¨ë¨)</div>

    <label>ì°¨ëŸ‰ë²ˆí˜¸</label>
    <input type="text" id="carNum" placeholder="ì˜ˆ: 12ê°€3456" />

    <label>ì—…ë¬´</label>
    <div class="status" style="background:#ecf0f1;color:#2c3e50"><strong id="taskText">ë¡œë”© ì¤‘...</strong></div>

    <button id="toggleBtn">ğŸ“ ìœ„ì¹˜ ì „ì†¡ ì‹œì‘</button>

    <div class="media-group">
      <input type="file" id="photoInput" accept="image/*" multiple hidden />
      <button class="media-btn photo" onclick="document.getElementById('photoInput').click()">ğŸ“¸ ì‚¬ì§„</button>

      <input type="file" id="fileInput" multiple hidden />
      <button class="media-btn file" onclick="document.getElementById('fileInput').click()">ğŸ“ íŒŒì¼</button>

      <button class="media-btn collapse" onclick="document.querySelector('.card').style.display='none'">ğŸ“¥ ì ‘ê¸°</button>
    </div>

    <div id="adminDelivery">
      <strong>ğŸ“¢ ê´€ë¦¬ì ì „ë‹¬ì‚¬í•­</strong>
      <div id="adminMemo"></div>
      <img id="adminPhoto" src="" style="display:none" />
      <div id="adminTime" style="font-size:13px;color:#7f8c8d;text-align:right"></div>
    </div>
  </div>

  <script>
    const config = {
      apiKey: "AIzaSyBMcqlyHzCO0k6G-6Fzb7AHso2A3gGAbq8",
      authDomain: "car-location-tracker-438f0.firebaseapp.com",
      projectId: "car-location-tracker-438f0",
      storageBucket: "car-location-tracker-438f0.firebasestorage.app",
      messagingSenderId: "645185980587",
      appId: "1:645185980587:web:f2b54d5df01cb14d300fee",
      measurementId: "G-B0BG1K096R"
    };
    firebase.initializeApp(config);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    let uid, watchId, tracking = false;

    auth.signInAnonymously().then(user => {
      uid = user.user.uid;
      db.ref('users/' + uid + '/task').on('value', snap => {
        document.getElementById('taskText').textContent = snap.val() || 'ì „ì²´';
      });
      db.ref('adminDelivery').on('value', snap => {
        const d = snap.val();
        if (!d) return;
        document.getElementById('adminMemo').textContent = d.memo || '';
        document.getElementById('adminTime').textContent = new Date(d.time).toLocaleString();
        if (d.photoUrl) {
          const img = document.getElementById('adminPhoto');
          img.src = d.photoUrl;
          img.style.display = 'block';
        }
      });
    });

    document.getElementById('toggleBtn').addEventListener('click', () => {
      const carNum = document.getElementById('carNum').value.trim();
      if (!carNum) return alert("ì°¨ëŸ‰ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

      if (tracking) {
        navigator.geolocation.clearWatch(watchId);
        tracking = false;
        document.getElementById('toggleBtn').textContent = 'ğŸ“ ìœ„ì¹˜ ì „ì†¡ ì‹œì‘';
        document.getElementById('trackingStatus').style.display = 'none';
      } else {
        watchId = navigator.geolocation.watchPosition(pos => {
          const { latitude, longitude } = pos.coords;
          db.ref('locations/' + uid).set({
            lat: latitude,
            lng: longitude,
            time: Date.now(),
            carNum
          });
        }, err => {
          alert("ìœ„ì¹˜ ì „ì†¡ ì‹¤íŒ¨: " + err.message);
        }, { enableHighAccuracy: true });
        tracking = true;
        document.getElementById('toggleBtn').textContent = 'ğŸ›‘ ìœ„ì¹˜ ì „ì†¡ ì¤‘ì§€';
        document.getElementById('trackingStatus').style.display = 'block';
      }
    });

    document.getElementById('photoInput').addEventListener('change', async e => {
      const files = Array.from(e.target.files);
      const urls = [];
      for (const file of files) {
        const ref = storage.ref(`uploads/${uid}/photos/${Date.now()}_${file.name}`);
        await ref.put(file);
        const url = await ref.getDownloadURL();
        urls.push(url);
      }
      await fetch('https://us-central1-YOUR_PROJECT_ID.cloudfunctions.net/sendTelegramPhotos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ uid, photoUrls: urls })
      });
      alert("ì‚¬ì§„ ì „ì†¡ ì™„ë£Œ!");
    });

    document.getElementById('fileInput').addEventListener('change', async e => {
      const files = Array.from(e.target.files);
      for (const file of files) {
        const ref = storage.ref(`uploads/${uid}/files/${Date.now()}_${file.name}`);
        await ref.put(file);
        const url = await ref.getDownloadURL();
        db.ref(`messages/${uid}`).push({
          type: 'file',
          url,
          name: file.name,
          time: Date.now()
        });
      }
      alert("íŒŒì¼ ì „ì†¡ ì™„ë£Œ!");
    });
  </script>
</body>
</html>