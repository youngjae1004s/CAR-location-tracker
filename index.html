<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì°¨ëŸ‰ ìœ„ì¹˜ ì‹œìŠ¤í…œ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:'Malgun Gothic',sans-serif }
    #map { height:100%; width:100%; position:absolute; top:0; left:0; z-index:0 }
    .card {
      position:fixed;
      bottom:20px;
      left:20px;
      width:320px;
      background:#fff;
      border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.2);
      padding:20px;
      z-index:10;
    }
    .panel {
      position:fixed;
      top:20px;
      right:20px;
      width:300px;
      background:#fff;
      border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.2);
      padding:16px;
      z-index:10;
      font-size:14px;
    }
    h2, h4 { margin-top:0; font-size:18px; color:#2c3e50 }
    label { font-weight:700; display:block; margin-top:12px }
    input[type="text"], textarea {
      width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; margin-bottom:10px
    }
    input[type="file"] { margin-bottom:10px }
    button {
      width:100%; padding:12px; font-weight:700; border:none; border-radius:8px;
      background:#2ecc71; color:#fff; cursor:pointer; margin-bottom:10px
    }
    .status { background:#ecf0f1; padding:10px; border-radius:8px; margin-bottom:10px }
    .media-group { display:flex; gap:8px; margin-bottom:10px }
    .media-group button { flex:1 }
    img { max-width:100%; border-radius:8px; margin-top:6px }
    .clickable { cursor:pointer; margin-bottom:10px }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- ì ‘ì†ì ì¹´ë“œ -->
  <div class="card">
    <h2>ğŸš— ì°¨ëŸ‰ ìœ„ì¹˜ ì „ì†¡</h2>
    <div id="trackingStatus" class="status" style="display:none">ğŸ“ ìœ„ì¹˜ ì „ì†¡ ì¤‘... (íƒ­ ë‹«ìœ¼ë©´ ì¤‘ë‹¨ë¨)</div>
    <label>ì°¨ëŸ‰ë²ˆí˜¸</label>
    <input type="text" id="carNum" placeholder="ì˜ˆ: 12ê°€3456" />
    <label>ì—…ë¬´</label>
    <div class="status"><strong id="taskText">ë¡œë”© ì¤‘...</strong></div>
    <button id="toggleBtn">ğŸ“ ìœ„ì¹˜ ì „ì†¡ ì‹œì‘</button>
    <div class="media-group">
      <input type="file" id="photoInput" accept="image/*" multiple hidden />
      <button onclick="document.getElementById('photoInput').click()">ğŸ“¸ ì‚¬ì§„</button>
      <input type="file" id="fileInput" multiple hidden />
      <button onclick="document.getElementById('fileInput').click()">ğŸ“ íŒŒì¼</button>
    </div>
  </div>

  <!-- ê´€ë¦¬ì íŒ¨ë„ -->
  <div class="panel">
    <h2>ğŸ“‹ ê´€ë¦¬ì íŒ¨ë„</h2>
    <h4>ì ‘ì†ì ìœ„ì¹˜</h4>
    <div id="locationList" class="status">ë¡œë”© ì¤‘...</div>
    <h4>ì „ì†¡ëœ íŒŒì¼/ì‚¬ì§„</h4>
    <div id="messageList" class="status">ë¡œë”© ì¤‘...</div>
    <h4>ì „ë‹¬ì‚¬í•­ ì „ì†¡</h4>
    <textarea id="adminMemoInput" placeholder="ì „ë‹¬í•  ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    <input type="file" id="adminPhotoInput" accept="image/*" />
    <button id="sendMemoBtn">ì „ë‹¬ì‚¬í•­ ì „ì†¡</button>
  </div>

  <script>
    const config = {
      apiKey: "AIzaSyBMcqlyHzCO0k6G-6Fzb7AHso2A3gGAbq8",
      authDomain: "car-location-tracker-438f0.firebaseapp.com",
      projectId: "car-location-tracker-438f0",
      storageBucket: "car-location-tracker-438f0.firebasestorage.app",
      messagingSenderId: "645185980587",
      appId: "1:645185980587:web:f2b54d5df01cb14d300fee",
      measurementId: "G-B0BG1K096R"
    };
    firebase.initializeApp(config);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    const map = L.map('map').setView([36.5, 127.8], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    const markers = {};
    let uid, watchId, tracking = false;

    auth.signInAnonymously().then(user => {
      uid = user.user.uid;

      db.ref('users/' + uid + '/task').on('value', snap => {
        document.getElementById('taskText').textContent = snap.val() || 'ì „ì²´';
      });

      db.ref('adminDelivery').on('value', snap => {
        const d = snap.val();
        if (!d) return;
        alert("ğŸ“¢ ê´€ë¦¬ì ì „ë‹¬ì‚¬í•­: " + d.memo);
      });

      listenToLocations();
      listenToMessages();
    });

    // ìœ„ì¹˜ ì „ì†¡
    document.getElementById('toggleBtn').addEventListener('click', () => {
      const carNum = document.getElementById('carNum').value.trim();
      if (!carNum) return alert("ì°¨ëŸ‰ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

      if (tracking) {
        navigator.geolocation.clearWatch(watchId);
        tracking = false;
        document.getElementById('toggleBtn').textContent = 'ğŸ“ ìœ„ì¹˜ ì „ì†¡ ì‹œì‘';
        document.getElementById('trackingStatus').style.display = 'none';
      } else {
        watchId = navigator.geolocation.watchPosition(pos => {
          const { latitude, longitude } = pos.coords;
          db.ref('locations/' + uid).set({
            lat: latitude,
            lng: longitude,
            time: Date.now(),
            carNum
          });
        }, err => {
          alert("ìœ„ì¹˜ ì „ì†¡ ì‹¤íŒ¨: " + err.message);
        }, { enableHighAccuracy: true });

        tracking = true;
        document.getElementById('toggleBtn').textContent = 'ğŸ›‘ ìœ„ì¹˜ ì „ì†¡ ì¤‘ì§€';
        document.getElementById('trackingStatus').style.display = 'block';
      }
    });

    // ì‚¬ì§„ ì—…ë¡œë“œ â†’ í…”ë ˆê·¸ë¨
    document.getElementById('photoInput').addEventListener('change', async e => {
      const files = Array.from(e.target.files);
      const urls = [];
      for (const file of files) {
        const ref = storage.ref(`uploads/${uid}/photos/${Date.now()}_${file.name}`);
        await ref.put(file);
        const url = await ref.getDownloadURL();
        urls.push(url);
      }
      await fetch('https://us-central1-YOUR_PROJECT_ID.cloudfunctions.net/sendTelegramPhotos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ uid, photoUrls: urls })
      });
      alert("ì‚¬ì§„ ì „ì†¡ ì™„ë£Œ!");
    });

    // íŒŒì¼ ì—…ë¡œë“œ â†’ í…”ë ˆê·¸ë¨
    document.getElementById('fileInput').addEventListener('change', async e => {
      const files = Array.from(e.target.files);
      for (const file of files) {
        const ref = storage.ref(`uploads/${uid}/files/${Date.now()}_${file.name}`);
        await ref.put(file);