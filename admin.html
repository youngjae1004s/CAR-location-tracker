<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>관리자 페이지</title>
  <!-- Leaflet CSS & JS (API 키 필요 없음) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <style>
    body { font-family: 'Malgun Gothic', sans-serif; margin:20px; background:#f5f7fa; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { border:1px solid #ddd; padding:12px; text-align:left; }
    th { background:#2c3e50; color:white; }
    select, button { padding:8px; border-radius:6px; cursor:pointer; }
    #mapModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:1000; }
    #mapContainer { width:90%; max-width:800px; height:80vh; background:#fff; border-radius:12px; overflow:hidden; position:relative; }
    #closeMap { position:absolute; top:15px; right:15px; padding:10px 16px; background:#e74c3c; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; z-index:10; }
    #map { width:100%; height:100%; }
  </style>
</head>
<body>
  <h1>관리자 페이지</h1>

  <div id="loginBox">
    <input type="password" id="adminPass" placeholder="관리자 비밀번호 입력" style="padding:12px; width:300px;">
    <button onclick="checkPassword()">로그인</button>
  </div>

  <div id="adminContent" style="display:none;">
    <h2>사용자 목록</h2>
    <table id="userTable">
      <thead>
        <tr>
          <th>UID</th>
          <th>차량번호</th>
          <th>업무</th>
          <th>마지막 위치 시간</th>
          <th>지도 보기</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- 지도 모달 -->
  <div id="mapModal">
    <div id="mapContainer">
      <button id="closeMap" onclick="document.getElementById('mapModal').style.display='none'">닫기</button>
      <div id="map"></div>
    </div>
  </div>

  <script>
const config = {
  apiKey: "AIzaSyBMcqlyHzCO0k6G-6Fzb7AHso2A3gGAbq8",
  authDomain: "car-location-tracker-438f0.firebaseapp.com",
  databaseURL: "https://car-location-tracker-438f0-default-rtdb.firebaseio.com",
  projectId: "car-location-tracker-438f0",
  storageBucket: "car-location-tracker-438f0.appspot.com",
  messagingSenderId: "645185980587",
  appId: "1:645185980587:web:f2b54d5df01cb14d300fee"
};

    firebase.initializeApp(config);
    const db = firebase.database();

    const ADMIN_PASSWORD = "123"; // ← 여기 변경하세요!

    function checkPassword() {
      const pass = document.getElementById('adminPass').value;
      if (pass === ADMIN_PASSWORD) {
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('adminContent').style.display = 'block';
        loadUsers();
      } else {
        alert("비밀번호 틀렸습니다.");
      }
    }

    let map; // 지도 인스턴스

    function loadUsers() {
      db.ref('locations').on('value', snap => {
        const tbody = document.querySelector('#userTable tbody');
        tbody.innerHTML = '';
        snap.forEach(child => {
          const data = child.val() || {};
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${child.key}</td>
            <td>${data.carNum || '-'}</td>
            <td>${data.task || '-'}</td>
            <td>${data.timestamp ? new Date(data.timestamp).toLocaleString('ko-KR') : '-'}</td>
            <td>
              ${data.lat && data.lng 
                ? `<button onclick="showMap(${data.lat}, ${data.lng}, '${data.carNum || '차량'}')">지도 보기</button>`
                : '위치 없음'}
            </td>
          `;
          tbody.appendChild(tr);
        });
      });
    }

    function showMap(lat, lng, title) {
      const modal = document.getElementById('mapModal');
      modal.style.display = 'flex';

      if (!map) {
        map = L.map('map').setView([lat, lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
      } else {
        map.setView([lat, lng], 15);
      }

      // 기존 마커 제거 후 새 마커 추가
      if (map.currentMarker) map.currentMarker.remove();
      map.currentMarker = L.marker([lat, lng]).addTo(map)
        .bindPopup(`<b>${title}</b><br>위도: ${lat}<br>경도: ${lng}`)
        .openPopup();
    }
  </script>
</body>
</html>