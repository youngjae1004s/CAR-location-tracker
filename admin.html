<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ê´€ë¦¬ì í˜ì´ì§€</title>
  <style>
    body {
      margin: 0;
      font-family: 'Malgun Gothic', sans-serif;
      background: #f5f7fa;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .card {
      width: 92%;
      max-width: 480px;
      background: #fff;
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
    }
    h2, h4 {
      text-align: center;
      color: #2c3e50;
    }
    .section {
      margin-top: 24px;
    }
    .status {
      background: #ecf0f1;
      padding: 12px;
      border-radius: 12px;
      font-size: 14px;
      color: #2c3e50;
      margin-bottom: 12px;
    }
    textarea {
      width: 100%;
      height: 80px;
      border-radius: 12px;
      padding: 10px;
      font-size: 15px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
    }
    input[type="file"] {
      margin-bottom: 12px;
    }
    button {
      width: 100%;
      padding: 12px;
      font-weight: 700;
      border: none;
      border-radius: 12px;
      background: #2ecc71;
      color: #fff;
      cursor: pointer;
    }
    img {
      max-width: 100%;
      border-radius: 12px;
      margin-top: 6px;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>
</head>
<body>
  <div class="card">
    <h2>ğŸ“‹ ê´€ë¦¬ì íŒ¨ë„</h2>

    <div class="section">
      <h4>ğŸš— ì ‘ì†ì ìœ„ì¹˜ ëª©ë¡</h4>
      <div id="locationList" class="status">ë¡œë”© ì¤‘...</div>
    </div>

    <div class="section">
      <h4>ğŸ“ ì „ì†¡ëœ íŒŒì¼/ì‚¬ì§„</h4>
      <div id="messageList" class="status" style="max-height:200px; overflow:auto">ë¡œë”© ì¤‘...</div>
    </div>

    <div class="section">
      <h4>ğŸ“¢ ì „ë‹¬ì‚¬í•­ ì „ì†¡</h4>
      <textarea id="adminMemoInput" placeholder="ì „ë‹¬í•  ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      <input type="file" id="adminPhotoInput" accept="image/*" />
      <button id="sendMemoBtn">ì „ë‹¬ì‚¬í•­ ì „ì†¡</button>
    </div>
  </div>

  <script>
    const config = {
      apiKey: "AIzaSyBMcqlyHzCO0k6G-6Fzb7AHso2A3gGAbq8",
      authDomain: "car-location-tracker-438f0.firebaseapp.com",
      projectId: "car-location-tracker-438f0",
      storageBucket: "car-location-tracker-438f0.firebasestorage.app",
      messagingSenderId: "645185980587",
      appId: "1:645185980587:web:f2b54d5df01cb14d300fee",
      measurementId: "G-B0BG1K096R"
    };
    firebase.initializeApp(config);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    auth.signInAnonymously().then(user => {
      listenToLocations();
      listenToMessages();
    });

    function listenToLocations() {
      const ref = db.ref('locations');
      ref.on('value', snapshot => {
        const data = snapshot.val() || {};
        const container = document.getElementById('locationList');
        container.innerHTML = '';

        Object.entries(data).forEach(([uid, loc]) => {
          const div = document.createElement('div');
          div.style.marginBottom = '12px';
          div.innerHTML = `
            <strong>${loc.carNum || 'ë¯¸ë“±ë¡ ì°¨ëŸ‰'}</strong><br/>
            ìœ„ë„: ${loc.lat.toFixed(5)}, ê²½ë„: ${loc.lng.toFixed(5)}<br/>
            ì‹œê°„: ${new Date(loc.time).toLocaleString()}
          `;
          container.appendChild(div);
        });

        if (Object.keys(data).length === 0) {
          container.textContent = 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ';
        }
      });
    }

    function listenToMessages() {
      const ref = db.ref('messages');
      ref.on('value', snapshot => {
        const data = snapshot.val() || {};
        const container = document.getElementById('messageList');
        container.innerHTML = '';

        Object.entries(data).forEach(([uid, messages]) => {
          Object.values(messages).forEach(msg => {
            const div = document.createElement('div');
            div.style.marginBottom = '12px';
            if (msg.type === 'file') {
              div.innerHTML = `
                <strong>íŒŒì¼:</strong> <a href="${msg.url}" target="_blank">${msg.name}</a><br/>
                ì‹œê°„: ${new Date(msg.time).toLocaleString()}
              `;
            } else if (msg.type === 'photo') {
              div.innerHTML = `
                <strong>ì‚¬ì§„:</strong><br/>
                <img src="${msg.url}" /><br/>
                ì‹œê°„: ${new Date(msg.time).toLocaleString()}
              `;
            }
            container.appendChild(div);
          });
        });

        if (Object.keys(data).length === 0) {
          container.textContent = 'ì „ì†¡ëœ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.';
        }
      });
    }

    document.getElementById('sendMemoBtn').addEventListener('click', async () => {
      const memo = document.getElementById('adminMemoInput').value.trim();
      const fileInput = document.getElementById('adminPhotoInput');
      const file = fileInput.files[0];

      let photoUrl = '';
      if (file) {
        const ref = storage.ref(`admin/photos/${Date.now()}_${file.name}`);
        await ref.put(file);
        photoUrl = await ref.getDownloadURL();
      }

      const data = {
        memo,
        photoUrl,
        time: Date.now()
      };

      await db.ref('adminDelivery').set(data);
      alert("ì „ë‹¬ì‚¬í•­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
    });
  </script>
</body>
</html>