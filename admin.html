<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì°¨ëŸ‰ ìœ„ì¹˜ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;800&display=swap" rel="stylesheet">
  
  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Noto Sans KR', sans-serif;
      overflow: hidden;
      height: 100vh;
    }
    
    /* ì „ì²´ í™”ë©´ ì§€ë„ */
    #mainMap {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      z-index: 1;
    }
    
    /* ì™¼ìª½ ì‚¬ì´ë“œë°” */
    .sidebar {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 380px;
      max-height: calc(100vh - 40px);
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .sidebar-header {
      padding: 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      flex-shrink: 0;
    }
    
    .sidebar-header h1 {
      font-size: 22px;
      font-weight: 800;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .sidebar-header .subtitle {
      font-size: 13px;
      opacity: 0.9;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      padding: 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #e5e7eb;
      flex-shrink: 0;
    }
    
    .stat-box {
      text-align: center;
      padding: 12px 8px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .stat-box .label {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 6px;
    }
    
    .stat-box .value {
      font-size: 24px;
      font-weight: 800;
      color: #1f2937;
    }
    
    .vehicle-list {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .vehicle-list::-webkit-scrollbar {
      width: 6px;
    }
    
    .vehicle-list::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }
    
    .vehicle-item {
      background: white;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    
    .vehicle-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      border-color: #667eea;
    }
    
    .vehicle-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .vehicle-number {
      font-size: 18px;
      font-weight: 800;
      color: #1f2937;
    }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .status-badge.online {
      background: #d1fae5;
      color: #065f46;
    }
    
    .status-badge.offline {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .vehicle-info {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    
    .vehicle-info strong {
      color: #374151;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #9ca3af;
    }
    
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 12px;
    }
    
    /* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤ */
    .controls {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      gap: 12px;
    }
    
    .control-btn {
      width: 48px;
      height: 48px;
      background: white;
      border: none;
      border-radius: 12px;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .control-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }
    
    .control-btn:active {
      transform: scale(0.95);
    }
    
    /* í† ê¸€ ë²„íŠ¼ */
    .toggle-sidebar {
      position: fixed;
      top: 50%;
      left: 420px;
      transform: translateY(-50%);
      width: 32px;
      height: 64px;
      background: rgba(255, 255, 255, 0.95);
      border: none;
      border-radius: 0 12px 12px 0;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 2px 0 12px rgba(0,0,0,0.1);
      z-index: 999;
      transition: all 0.3s;
    }
    
    .sidebar.collapsed {
      transform: translateX(-420px);
    }
    
    .sidebar.collapsed + .toggle-sidebar {
      left: 20px;
      border-radius: 12px;
    }
    
    /* Leaflet íŒì—… ì»¤ìŠ¤í…€ */
    .custom-popup {
      text-align: center;
      padding: 8px;
    }
    
    .custom-popup .car-number {
      font-size: 18px;
      font-weight: 800;
      color: #1f2937;
      margin-bottom: 8px;
    }
    
    .custom-popup .info-item {
      font-size: 12px;
      color: #6b7280;
      margin: 4px 0;
    }
    
    .custom-popup .info-item strong {
      color: #374151;
    }
    
    /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
      font-size: 20px;
      font-weight: 600;
    }
    
    .loading-overlay.hidden {
      display: none;
    }
    
    /* ëª¨ë°”ì¼ ëŒ€ì‘ */
    @media (max-width: 768px) {
      .sidebar {
        width: calc(100% - 40px);
        max-height: 50vh;
      }
      
      .toggle-sidebar {
        display: none;
      }
      
      .controls {
        bottom: 20px;
        top: auto;
        right: 20px;
      }
    }
  </style>
</head>
<body>

<!-- ë¡œë”© í™”ë©´ -->
<div class="loading-overlay" id="loadingOverlay">
  ğŸ”„ ì§€ë„ ë¡œë”© ì¤‘...
</div>

<!-- ì „ì²´ í™”ë©´ ì§€ë„ -->
<div id="mainMap"></div>

<!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h1>ğŸš— ì°¨ëŸ‰ ìœ„ì¹˜ ê´€ë¦¬</h1>
    <div class="subtitle">ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ</div>
  </div>
  
  <div class="stats-grid">
    <div class="stat-box">
      <div class="label">ì „ì²´</div>
      <div class="value" id="totalVehicles">0</div>
    </div>
    <div class="stat-box">
      <div class="label">í™œì„±</div>
      <div class="value" style="color: #10b981;" id="activeVehicles">0</div>
    </div>
    <div class="stat-box">
      <div class="label">ë¹„í™œì„±</div>
      <div class="value" style="color: #ef4444;" id="inactiveVehicles">0</div>
    </div>
  </div>
  
  <div class="vehicle-list" id="vehicleList">
    <div class="empty-state">
      <div class="icon">ğŸ”</div>
      <div>ì°¨ëŸ‰ ì •ë³´ ë¡œë”© ì¤‘...</div>
    </div>
  </div>
</div>

<!-- ì‚¬ì´ë“œë°” í† ê¸€ ë²„íŠ¼ -->
<button class="toggle-sidebar" id="toggleSidebar" onclick="toggleSidebar()">
  â—€
</button>

<!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
<div class="controls">
  <button class="control-btn" onclick="refreshData()" title="ìƒˆë¡œê³ ì¹¨">
    ğŸ”„
  </button>
  <button class="control-btn" onclick="fitAllMarkers()" title="ì „ì²´ ë³´ê¸°">
    ğŸ¯
  </button>
</div>

<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyBMcqlyHzCO0k6G-6Fzb7AHso2A3gGAbq8",
  authDomain: "car-location-tracker-438f0.firebaseapp.com",
  databaseURL: "https://car-location-tracker-438f0-default-rtdb.firebaseio.com",
  projectId: "car-location-tracker-438f0",
  storageBucket: "car-location-tracker-438f0.appspot.com",
  messagingSenderId: "645185980587",
  appId: "1:645185980587:web:f2b54d5df01cb14d300fee"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let map = null;
let markers = {};
let vehicleData = [];

// ì´ˆê¸°í™”
window.addEventListener('load', () => {
  initMap();
  loadVehicleData();
});

// ì§€ë„ ì´ˆê¸°í™”
function initMap() {
  try {
    // ëŒ€í•œë¯¼êµ­ ì¤‘ì‹¬ (ì„œìš¸)
    map = L.map('mainMap').setView([37.5665, 126.9780], 7);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);
    
    // ë¡œë”© í™”ë©´ ì œê±°
    setTimeout(() => {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }, 500);
    
    console.log('âœ… ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ');
  } catch (error) {
    console.error('âŒ ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    alert('ì§€ë„ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
  }
}

// Firebaseì—ì„œ ì°¨ëŸ‰ ë°ì´í„° ë¡œë“œ
function loadVehicleData() {
  console.log('ğŸ”„ Firebase ë°ì´í„° ë¡œë”© ì‹œì‘...');
  
  db.ref('locations').on('value', snapshot => {
    vehicleData = [];
    const now = Date.now();
    
    snapshot.forEach(child => {
      const uid = child.key;
      const data = child.val() || {};
      
      if (data.lat && data.lng) {
        const lastUpdate = data.timestamp || 0;
        const isActive = (now - lastUpdate) < 300000; // 5ë¶„ ì´ë‚´
        
        vehicleData.push({
          uid: uid,
          carNum: data.carNum || 'ë¯¸ë“±ë¡',
          task: data.task || '-',
          lat: data.lat,
          lng: data.lng,
          accuracy: data.accuracy,
          timestamp: data.timestamp,
          isActive: isActive
        });
      }
    });
    
    updateStats();
    updateVehicleList();
    updateMapMarkers();
    
    console.log(`âœ… ${vehicleData.length}ê°œ ì°¨ëŸ‰ ë¡œë“œ ì™„ë£Œ`);
  }, error => {
    console.error('âŒ Firebase ì˜¤ë¥˜:', error);
  });
}

// í†µê³„ ì—…ë°ì´íŠ¸
function updateStats() {
  const total = vehicleData.length;
  const active = vehicleData.filter(v => v.isActive).length;
  const inactive = total - active;
  
  document.getElementById('totalVehicles').textContent = total;
  document.getElementById('activeVehicles').textContent = active;
  document.getElementById('inactiveVehicles').textContent = inactive;
}

// ì°¨ëŸ‰ ëª©ë¡ ì—…ë°ì´íŠ¸
function updateVehicleList() {
  const listContainer = document.getElementById('vehicleList');
  
  if (vehicleData.length === 0) {
    listContainer.innerHTML = `
      <div class="empty-state">
        <div class="icon">ğŸ“­</div>
        <div>ë“±ë¡ëœ ì°¨ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤</div>
      </div>
    `;
    return;
  }
  
  listContainer.innerHTML = '';
  
  vehicleData.forEach(vehicle => {
    const item = document.createElement('div');
    item.className = 'vehicle-item';
    item.onclick = () => focusVehicle(vehicle);
    
    item.innerHTML = `
      <div class="vehicle-header">
        <div class="vehicle-number">${vehicle.carNum}</div>
        <div class="status-badge ${vehicle.isActive ? 'online' : 'offline'}">
          ${vehicle.isActive ? 'ğŸŸ¢ í™œì„±' : 'ğŸ”´ ë¹„í™œì„±'}
        </div>
      </div>
      <div class="vehicle-info">
        <strong>ì—…ë¬´:</strong> ${vehicle.task}
      </div>
      <div class="vehicle-info">
        <strong>ì •í™•ë„:</strong> ${vehicle.accuracy ? Math.round(vehicle.accuracy) + 'm' : '-'}
      </div>
      <div class="vehicle-info">
        <strong>ì‹œê°„:</strong> ${new Date(vehicle.timestamp).toLocaleTimeString('ko-KR')}
      </div>
    `;
    
    listContainer.appendChild(item);
  });
}

// ì§€ë„ ë§ˆì»¤ ì—…ë°ì´íŠ¸
function updateMapMarkers() {
  if (!map) return;
  
  // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
  Object.values(markers).forEach(marker => marker.remove());
  markers = {};
  
  // ìƒˆ ë§ˆì»¤ ì¶”ê°€
  vehicleData.forEach(vehicle => {
    const iconHtml = vehicle.isActive 
      ? 'ğŸŸ¢' 
      : 'ğŸ”´';
    
    const customIcon = L.divIcon({
      html: `<div style="font-size: 24px;">${iconHtml}</div>`,
      className: 'custom-marker',
      iconSize: [30, 30],
      iconAnchor: [15, 15]
    });
    
    const marker = L.marker([vehicle.lat, vehicle.lng], { icon: customIcon })
      .addTo(map);
    
    marker.bindPopup(`
      <div class="custom-popup">
        <div class="car-number">${vehicle.carNum}</div>
        <div class="info-item"><strong>ì—…ë¬´:</strong> ${vehicle.task}</div>
        <div class="info-item"><strong>ì •í™•ë„:</strong> ${vehicle.accuracy ? Math.round(vehicle.accuracy) + 'm' : '-'}</div>
        <div class="info-item"><strong>ì‹œê°„:</strong> ${new Date(vehicle.timestamp).toLocaleTimeString('ko-KR')}</div>
      </div>
    `);
    
    markers[vehicle.uid] = marker;
  });
}

// íŠ¹ì • ì°¨ëŸ‰ì— í¬ì»¤ìŠ¤
function focusVehicle(vehicle) {
  if (!map || !markers[vehicle.uid]) return;
  
  map.setView([vehicle.lat, vehicle.lng], 16);
  markers[vehicle.uid].openPopup();
  
  console.log(`ğŸ“ ${vehicle.carNum} ìœ„ì¹˜ë¡œ ì´ë™`);
}

// ëª¨ë“  ë§ˆì»¤ê°€ ë³´ì´ë„ë¡ ì¡°ì •
function fitAllMarkers() {
  if (!map || vehicleData.length === 0) return;
  
  const bounds = L.latLngBounds(
    vehicleData.map(v => [v.lat, v.lng])
  );
  
  map.fitBounds(bounds, { padding: [50, 50] });
  console.log('ğŸ¯ ì „ì²´ ì°¨ëŸ‰ ë³´ê¸°');
}

// ë°ì´í„° ìƒˆë¡œê³ ì¹¨
function refreshData() {
  console.log('ğŸ”„ ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨');
  loadVehicleData();
}

// ì‚¬ì´ë“œë°” í† ê¸€
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const toggleBtn = document.getElementById('toggleSidebar');
  
  sidebar.classList.toggle('collapsed');
  toggleBtn.textContent = sidebar.classList.contains('collapsed') ? 'â–¶' : 'â—€';
  
  // ì§€ë„ í¬ê¸° ì¬ì¡°ì •
  setTimeout(() => {
    if (map) map.invalidateSize();
  }, 300);
}
</script>

</body>
</html>
