<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì°¨ëŸ‰ ìœ„ì¹˜ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;800&display=swap" rel="stylesheet">
  
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Noto Sans KR', sans-serif; overflow: hidden; height: 100vh; }
    
    #mainMap { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 1; }
    
    .sidebar {
      position: fixed; top: 20px; left: 20px; width: 400px; max-height: calc(100vh - 40px);
      background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
      border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      z-index: 1000; display: flex; flex-direction: column; overflow: hidden;
    }
    
    .sidebar-header {
      padding: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; flex-shrink: 0;
    }
    
    .sidebar-header h1 {
      font-size: 22px; font-weight: 800; margin-bottom: 8px;
      display: flex; align-items: center; gap: 10px;
    }
    
    .stats-grid {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;
      padding: 20px; background: #f8f9fa; border-bottom: 1px solid #e5e7eb;
    }
    
    .stat-box {
      text-align: center; padding: 12px 8px; background: white;
      border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .stat-box .label { font-size: 11px; color: #6b7280; margin-bottom: 6px; }
    .stat-box .value { font-size: 24px; font-weight: 800; color: #1f2937; }
    
    .vehicle-list { flex: 1; overflow-y: auto; padding: 16px; }
    .vehicle-list::-webkit-scrollbar { width: 6px; }
    .vehicle-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    
    .vehicle-item {
      background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08); cursor: pointer;
      transition: all 0.2s; border: 2px solid transparent;
    }
    
    .vehicle-item:hover {
      transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      border-color: #667eea;
    }
    
    .vehicle-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
    }
    
    .vehicle-number { font-size: 18px; font-weight: 800; color: #1f2937; }
    
    .status-badge {
      padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 700;
    }
    
    .status-badge.online { background: #d1fae5; color: #065f46; }
    .status-badge.offline { background: #fee2e2; color: #991b1b; }
    
    .vehicle-info { font-size: 13px; color: #6b7280; margin-bottom: 4px; }
    .vehicle-info strong { color: #374151; }
    
    .empty-state {
      text-align: center; padding: 40px 20px; color: #9ca3af;
    }
    
    .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
    
    .controls {
      position: fixed; top: 20px; right: 20px; z-index: 1000;
      display: flex; gap: 12px;
    }
    
    .control-btn {
      width: 48px; height: 48px; background: white; border: none;
      border-radius: 12px; font-size: 20px; cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.2s;
    }
    
    .control-btn:hover { transform: scale(1.05); }
    
    .debug-panel {
      padding: 16px; background: #f3f4f6; border-top: 1px solid #e5e7eb;
      font-size: 11px; color: #6b7280; max-height: 150px; overflow-y: auto;
    }
    
    .success { color: #10b981; font-weight: bold; }
    .error { color: #ef4444; font-weight: bold; }
  </style>
</head>
<body>

<div id="mainMap"></div>

<div class="sidebar">
  <div class="sidebar-header">
    <h1>ğŸš— ì°¨ëŸ‰ ìœ„ì¹˜ ê´€ë¦¬</h1>
    <div style="font-size: 13px; opacity: 0.9;">ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ</div>
  </div>
  
  <div class="stats-grid">
    <div class="stat-box">
      <div class="label">ì „ì²´</div>
      <div class="value" id="totalVehicles">0</div>
    </div>
    <div class="stat-box">
      <div class="label">í™œì„±</div>
      <div class="value" style="color: #10b981;" id="activeVehicles">0</div>
    </div>
    <div class="stat-box">
      <div class="label">ë¹„í™œì„±</div>
      <div class="value" style="color: #ef4444;" id="inactiveVehicles">0</div>
    </div>
  </div>
  
  <div class="vehicle-list" id="vehicleList">
    <div class="empty-state">
      <div class="icon">ğŸ”</div>
      <div>ë¡œê·¸ì¸ ì¤‘...</div>
    </div>
  </div>
  
  <div class="debug-panel">
    <strong>ğŸ“Š ì—°ê²° ìƒíƒœ</strong>
    <div id="debugLog">ì‹œìŠ¤í…œ ì‹œì‘...</div>
  </div>
</div>

<div class="controls">
  <button class="control-btn" onclick="location.reload()" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
  <button class="control-btn" onclick="fitAllMarkers()" title="ì „ì²´ ë³´ê¸°">ğŸ¯</button>
</div>

<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyBMcqlyHzCO0k6G-6Fzb7AHso2A3gGAbq8",
  authDomain: "car-location-tracker-438f0.firebaseapp.com",
  databaseURL: "https://car-location-tracker-438f0-default-rtdb.firebaseio.com",
  projectId: "car-location-tracker-438f0",
  storageBucket: "car-location-tracker-438f0.appspot.com",
  messagingSenderId: "645185980587",
  appId: "1:645185980587:web:f2b54d5df01cb14d300fee"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let map = null;
let markers = {};
let vehicleData = [];

// Debug
function addLog(msg, type = 'info') {
  const log = document.getElementById('debugLog');
  const time = new Date().toLocaleTimeString('ko-KR');
  const div = document.createElement('div');
  div.className = type;
  div.innerHTML = `<strong>${time}</strong>: ${msg}`;
  log.appendChild(div);
  if (log.children.length > 8) log.removeChild(log.firstChild);
  console.log(`[${time}] ${msg}`);
}

// Init
window.addEventListener('load', () => {
  initMap();
  initAuth();
});

function initMap() {
  try {
    map = L.map('mainMap').setView([37.5665, 126.9780], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap',
      maxZoom: 19
    }).addTo(map);
    addLog('âœ… ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ', 'success');
  } catch (e) {
    addLog('âŒ ì§€ë„ ì˜¤ë¥˜: ' + e.message, 'error');
  }
}

function initAuth() {
  addLog('ì¸ì¦ ì‹œì‘...');
  auth.signInAnonymously()
    .then(cred => {
      addLog(`âœ… ì¸ì¦ ì„±ê³µ (${cred.user.uid.substring(0,8)}...)`, 'success');
      loadData();
      
      db.ref('.info/connected').on('value', snap => {
        if (snap.val()) {
          addLog('âœ… Firebase ì—°ê²°ë¨', 'success');
        } else {
          addLog('âš ï¸ Firebase ì—°ê²° ëŠê¹€', 'error');
        }
      });
    })
    .catch(e => addLog('âŒ ì¸ì¦ ì‹¤íŒ¨: ' + e.message, 'error'));
}

function loadData() {
  addLog('ë°ì´í„° ë¡œë”© ì‹œì‘...');
  
  db.ref('locations').on('value', snap => {
    addLog('ğŸ“¡ ë°ì´í„° ìˆ˜ì‹ ');
    vehicleData = [];
    const now = Date.now();
    
    if (!snap.exists()) {
      addLog('âš ï¸ ë°ì´í„° ì—†ìŒ', 'error');
      updateEmpty();
      return;
    }
    
    snap.forEach(child => {
      const data = child.val();
      if (data && data.lat && data.lng) {
        const isActive = (now - data.timestamp) < 300000;
        vehicleData.push({
          uid: child.key,
          carNum: data.carNum || 'ë¯¸ë“±ë¡',
          task: data.task || '-',
          lat: data.lat,
          lng: data.lng,
          accuracy: data.accuracy,
          timestamp: data.timestamp,
          isActive: isActive
        });
        addLog(`âœ“ ${data.carNum}`, 'success');
      }
    });
    
    addLog(`ğŸ“Š ${vehicleData.length}ê°œ ì°¨ëŸ‰ ë¡œë“œ`, 'success');
    updateStats();
    updateList();
    updateMarkers();
  }, e => addLog('âŒ ë°ì´í„° ì˜¤ë¥˜: ' + e.message, 'error'));
}

function updateEmpty() {
  document.getElementById('vehicleList').innerHTML = `
    <div class="empty-state">
      <div class="icon">ğŸ“­</div>
      <div>ë“±ë¡ëœ ì°¨ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤</div>
    </div>`;
  updateStats();
}

function updateStats() {
  const total = vehicleData.length;
  const active = vehicleData.filter(v => v.isActive).length;
  document.getElementById('totalVehicles').textContent = total;
  document.getElementById('activeVehicles').textContent = active;
  document.getElementById('inactiveVehicles').textContent = total - active;
}

function updateList() {
  const list = document.getElementById('vehicleList');
  if (vehicleData.length === 0) {
    updateEmpty();
    return;
  }
  
  list.innerHTML = '';
  vehicleData.forEach(v => {
    const item = document.createElement('div');
    item.className = 'vehicle-item';
    item.onclick = () => focusVehicle(v);
    item.innerHTML = `
      <div class="vehicle-header">
        <div class="vehicle-number">${v.carNum}</div>
        <div class="status-badge ${v.isActive ? 'online' : 'offline'}">
          ${v.isActive ? 'ğŸŸ¢ í™œì„±' : 'ğŸ”´ ë¹„í™œì„±'}
        </div>
      </div>
      <div class="vehicle-info"><strong>ì—…ë¬´:</strong> ${v.task}</div>
      <div class="vehicle-info"><strong>ìœ„ì¹˜:</strong> ${v.lat.toFixed(6)}, ${v.lng.toFixed(6)}</div>
      <div class="vehicle-info"><strong>ì •í™•ë„:</strong> ${v.accuracy ? Math.round(v.accuracy) + 'm' : '-'}</div>
      <div class="vehicle-info"><strong>ì‹œê°„:</strong> ${new Date(v.timestamp).toLocaleString('ko-KR')}</div>
    `;
    list.appendChild(item);
  });
}

function updateMarkers() {
  if (!map) return;
  Object.values(markers).forEach(m => m.remove());
  markers = {};
  
  vehicleData.forEach(v => {
    const icon = L.divIcon({
      html: `<div style="font-size: 28px;">${v.isActive ? 'ğŸŸ¢' : 'ğŸ”´'}</div>`,
      iconSize: [32, 32],
      iconAnchor: [16, 16]
    });
    
    const marker = L.marker([v.lat, v.lng], { icon }).addTo(map);
    marker.bindPopup(`
      <div style="text-align:center; padding:8px;">
        <strong style="font-size:18px;">${v.carNum}</strong><br>
        <div style="margin-top:8px; font-size:12px; color:#666;">
          ì—…ë¬´: ${v.task}<br>
          ì •í™•ë„: ${v.accuracy ? Math.round(v.accuracy) + 'm' : '-'}<br>
          ì‹œê°„: ${new Date(v.timestamp).toLocaleTimeString('ko-KR')}
        </div>
      </div>
    `);
    markers[v.uid] = marker;
  });
  
  addLog(`âœ… ${vehicleData.length}ê°œ ë§ˆì»¤ í‘œì‹œ`, 'success');
}

function focusVehicle(v) {
  if (map && markers[v.uid]) {
    map.setView([v.lat, v.lng], 16);
    markers[v.uid].openPopup();
  }
}

function fitAllMarkers() {
  if (!map || vehicleData.length === 0) return;
  const bounds = L.latLngBounds(vehicleData.map(v => [v.lat, v.lng]));
  map.fitBounds(bounds, { padding: [50, 50] });
}
</script>

</body>
</html>
