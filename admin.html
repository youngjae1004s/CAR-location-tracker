<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì°¨ëŸ‰ ìœ„ì¹˜ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;800&display=swap" rel="stylesheet">
  
  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Noto Sans KR', sans-serif;
      overflow: hidden;
      height: 100vh;
    }
    
    #mainMap {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      z-index: 1;
    }
    
    .sidebar {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 400px;
      max-height: calc(100vh - 40px);
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .sidebar-header {
      padding: 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      flex-shrink: 0;
    }
    
    .sidebar-header h1 {
      font-size: 22px;
      font-weight: 800;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .sidebar-header .subtitle {
      font-size: 13px;
      opacity: 0.9;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      padding: 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #e5e7eb;
      flex-shrink: 0;
    }
    
    .stat-box {
      text-align: center;
      padding: 12px 8px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .stat-box .label {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 6px;
    }
    
    .stat-box .value {
      font-size: 24px;
      font-weight: 800;
      color: #1f2937;
    }
    
    .vehicle-list {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .vehicle-list::-webkit-scrollbar {
      width: 6px;
    }
    
    .vehicle-list::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }
    
    .vehicle-item {
      background: white;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    
    .vehicle-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      border-color: #667eea;
    }
    
    .vehicle-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .vehicle-number {
      font-size: 18px;
      font-weight: 800;
      color: #1f2937;
    }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .status-badge.online {
      background: #d1fae5;
      color: #065f46;
    }
    
    .status-badge.offline {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .vehicle-info {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    
    .vehicle-info strong {
      color: #374151;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #9ca3af;
    }
    
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 12px;
    }
    
    .controls {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      gap: 12px;
    }
    
    .control-btn {
      width: 48px;
      height: 48px;
      background: white;
      border: none;
      border-radius: 12px;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .control-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }
    
    .toggle-sidebar {
      position: fixed;
      top: 50%;
      left: 440px;
      transform: translateY(-50%);
      width: 32px;
      height: 64px;
      background: rgba(255, 255, 255, 0.95);
      border: none;
      border-radius: 0 12px 12px 0;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 2px 0 12px rgba(0,0,0,0.1);
      z-index: 999;
      transition: all 0.3s;
    }
    
    .sidebar.collapsed {
      transform: translateX(-440px);
    }
    
    .sidebar.collapsed + .toggle-sidebar {
      left: 20px;
      border-radius: 12px;
    }
    
    .custom-popup {
      text-align: center;
      padding: 8px;
    }
    
    .custom-popup .car-number {
      font-size: 18px;
      font-weight: 800;
      color: #1f2937;
      margin-bottom: 8px;
    }
    
    .custom-popup .info-item {
      font-size: 12px;
      color: #6b7280;
      margin: 4px 0;
    }
    
    .custom-popup .info-item strong {
      color: #374151;
    }
    
    .debug-panel {
      padding: 16px;
      background: #f3f4f6;
      border-top: 1px solid #e5e7eb;
      font-size: 11px;
      color: #6b7280;
      max-height: 150px;
      overflow-y: auto;
      flex-shrink: 0;
    }
    
    .debug-panel .log-item {
      margin: 4px 0;
      padding: 4px 0;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .debug-panel .success {
      color: #10b981;
      font-weight: bold;
    }
    
    .debug-panel .error {
      color: #ef4444;
      font-weight: bold;
    }
    
    @media (max-width: 768px) {
      .sidebar {
        width: calc(100% - 40px);
        max-height: 50vh;
      }
      
      .toggle-sidebar {
        display: none;
      }
      
      .controls {
        bottom: 20px;
        top: auto;
      }
    }
  </style>
</head>
<body>

<!-- ì „ì²´ í™”ë©´ ì§€ë„ -->
<div id="mainMap"></div>

<!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h1>ğŸš— ì°¨ëŸ‰ ìœ„ì¹˜ ê´€ë¦¬</h1>
    <div class="subtitle">ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ</div>
  </div>
  
  <div class="stats-grid">
    <div class="stat-box">
      <div class="label">ì „ì²´</div>
      <div class="value" id="totalVehicles">0</div>
    </div>
    <div class="stat-box">
      <div class="label">í™œì„±</div>
      <div class="value" style="color: #10b981;" id="activeVehicles">0</div>
    </div>
    <div class="stat-box">
      <div class="label">ë¹„í™œì„±</div>
      <div class="value" style="color: #ef4444;" id="inactiveVehicles">0</div>
    </div>
  </div>
  
  <div class="vehicle-list" id="vehicleList">
    <div class="empty-state">
      <div class="icon">ğŸ”</div>
      <div>ë¡œê·¸ì¸ ì¤‘...</div>
    </div>
  </div>
  
  <div class="debug-panel" id="debugPanel">
    <strong>ğŸ“Š ì—°ê²° ìƒíƒœ</strong>
    <div id="debugLog">
      <div class="log-item">ì‹œìŠ¤í…œ ì‹œì‘...</div>
    </div>
  </div>
</div>

<!-- ì‚¬ì´ë“œë°” í† ê¸€ -->
<button class="toggle-sidebar" id="toggleSidebar" onclick="toggleSidebar()">
  â—€
</button>

<!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
<div class="controls">
  <button class="control-btn" onclick="refreshData()" title="ìƒˆë¡œê³ ì¹¨">
    ğŸ”„
  </button>
  <button class="control-btn" onclick="fitAllMarkers()" title="ì „ì²´ ë³´ê¸°">
    ğŸ¯
  </button>
</div>

<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyBMcqlyHzCO0k6G-6Fzb7AHso2A3gGAbq8",
  authDomain: "car-location-tracker-438f0.firebaseapp.com",
  databaseURL: "https://car-location-tracker-438f0-default-rtdb.firebaseio.com",
  projectId: "car-location-tracker-438f0",
  storageBucket: "car-location-tracker-438f0.appspot.com",
  messagingSenderId: "645185980587",
  appId: "1:645185980587:web:f2b54d5df01cb14d300fee"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let map = null;
let markers = {};
let vehicleData = [];
let isAuthenticated = false;

// Debug logging
function addDebugLog(message, type = 'info') {
  const debugLog = document.getElementById('debugLog');
  const time = new Date().toLocaleTimeString('ko-KR');
  const logItem = document.createElement('div');
  logItem.className = `log-item ${type}`;
  logItem.innerHTML = `<strong>${time}</strong>: ${message}`;
  debugLog.appendChild(logItem);
  
  if (debugLog.children.length > 8) {
    debugLog.removeChild(debugLog.firstChild);
  }
  
  console.log(`[${time}] ${message}`);
}

// ì´ˆê¸°í™”
window.addEventListener('load', () => {
  addDebugLog('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘');
  initMap();
  initAuth();
});

// Firebase ì¸ì¦ (ìµëª… ë¡œê·¸ì¸)
function initAuth() {
  addDebugLog('Firebase ìµëª… ì¸ì¦ ì‹œì‘...');
  
  auth.signInAnonymously()
    .then(credential => {
      isAuthenticated = true;
      addDebugLog(`âœ… ê´€ë¦¬ì ì¸ì¦ ì„±ê³µ (UID: ${credential.user.uid.substring(0, 8)}...)`, 'success');
      
      // ì¸ì¦ í›„ ë°ì´í„° ë¡œë“œ
      loadVehicleData();
      checkFirebaseConnection();
    })
    .catch(error => {
      addDebugLog(`âŒ ì¸ì¦ ì‹¤íŒ¨: ${error.message}`, 'error');
      console.error('ì¸ì¦ ì˜¤ë¥˜:', error);
    });
}

// Firebase ì—°ê²° ìƒíƒœ í™•ì¸
function checkFirebaseConnection() {
  db.ref('.info/connected').on('value', snapshot => {
    if (snapshot.val() === true) {
      addDebugLog('âœ… Firebase ì‹¤ì‹œê°„ ì—°ê²°ë¨', 'success');
    } else {
      addDebugLog('âš ï¸ Firebase ì—°ê²° ëŠê¹€', 'error');
    }
  });
}

// ì§€ë„ ì´ˆê¸°í™”
function initMap() {
  try {
    map = L.map('mainMap').setView([37.5665, 126.9780], 7);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);
    
    addDebugLog('âœ… ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ', 'success');
  } catch (error) {
    addDebugLog('âŒ ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message, 'error');
    console.error('ì§€ë„ ì˜¤ë¥˜:', error);
  }
}

// Firebaseì—ì„œ ì°¨ëŸ‰ ë°ì´í„° ë¡œë“œ
function loadVehicleData() {
  if (!isAuthenticated) {
    addDebugLog('âš ï¸ ì¸ì¦ ëŒ€ê¸° ì¤‘...', 'error');
    return;
  }
  
  addDebugLog('Firebase ë°ì´í„° ë¦¬ìŠ¤ë„ˆ ë“±ë¡...');
  
  // locations ê²½ë¡œ ì‹¤ì‹œê°„ ê°ì‹œ
  db.ref('locations').on('value', snapshot => {
    addDebugLog('ğŸ“¡ Firebase ë°ì´í„° ìˆ˜ì‹ ë¨');
    
    vehicleData = [];
    const now = Date.now();
    let dataCount = 0;
    
    if (!snapshot.exists()) {
      addDebugLog('âš ï¸ locations ë°ì´í„° ì—†ìŒ', 'error');
      updateEmptyState();
      return;
    }
    
    snapshot.forEach(child => {
      const uid = child.key;
      const data = child.val();
      dataCount++;
      
      addDebugLog(`ğŸ“¦ UID ${uid.substring(0, 8)}: ${data.carNum || 'ë¯¸ë“±ë¡'}`);
      
      if (data && data.lat && data.lng) {
        const lastUpdate = data.timestamp || 0;
        const isActive = (now - lastUpdate) < 300000; // 5ë¶„
        
        vehicleData.push({
          uid: uid,
          carNum: data.carNum || 'ë¯¸ë“±ë¡',
          task: data.task || '-',
          lat: data.lat,
          lng: data.lng,
          accuracy: data.accuracy,
          timestamp: data.timestamp,
          isActive: isActive
        });
        
        addDebugLog(`âœ“ ì°¨ëŸ‰ ì¶”ê°€: ${data.carNum} (${data.lat.toFixed(4)}, ${data.lng.toFixed(4)})`, 'success');
      } else {
        addDebugLog(`âš ï¸ UID ${uid.substring(0, 8)}: ìœ„ì¹˜ ë°ì´í„° ì—†ìŒ`, 'error');
      }
    });
    
    addDebugLog(`ğŸ“Š ì´ ${dataCount}ê°œ í•­ëª©, ${vehicleData.length}ê°œ ìœ íš¨ ì°¨ëŸ‰`, 'success');
    
    updateStats();
    updateVehicleList();
    updateMapMarkers();
  }, error => {
    addDebugLog('âŒ Firebase ì˜¤ë¥˜: ' + error.message, 'error');
    console.error('Firebase ì˜¤ë¥˜:', error);
  });
}

// ë¹ˆ ìƒíƒœ í‘œì‹œ
function updateEmptyState() {
  const listContainer = document.getElementById('vehicleList');
  listContainer.innerHTML = `
    <div class="empty-state">
      <div class="icon">ğŸ“­</div>
      <div>ë“±ë¡ëœ ì°¨ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤</div>
      <div style="font-size: 12px; margin-top: 8px;">
        ì•±ì—ì„œ ìœ„ì¹˜ ì „ì†¡ì„ ì‹œì‘í•˜ì„¸ìš”
      </div>
    </div>
  `;
  
  updateStats();
}

// í†µê³„ ì—…ë°ì´íŠ¸
function updateStats() {
  const total = vehicleData.length;
  const active = vehicleData.filter(v => v.isActive).length;
  const inactive = total - active;
  
  document.getElementById('totalVehicles').textContent = total;
  document.getElementById('activeVehicles').textContent = active;
  document.getElementById('inactiveVehicles').textContent = inactive;
}

// ì°¨ëŸ‰ ëª©ë¡ ì—…ë°ì´íŠ¸
function updateVehicleList() {
  const listContainer = document.getElementById('vehicleList');
  
  if (vehicleData.length === 0) {
    updateEmptyState();
    return;
  }
  
  listContainer.innerHTML = '';
  
  vehicleData.forEach(vehicle => {
    const item = document.createElement('div');
    item.className = 'vehicle-item';
    item.onclick = () => focusVehicle(vehicle);
    
    item.innerHTML = `
      <div class="vehicle-header">
        <div class="vehicle-number">${vehicle.carNum}</div>
        <div class="status-badge ${vehicle.isActive ? 'online' : 'offline'}">
          ${vehicle.isActive ? 'ğŸŸ¢ í™œì„±' : 'ğŸ”´ ë¹„í™œì„±'}
        </div>
      </div>
      <div class="vehicle-info">
        <strong>ì—…ë¬´:</strong> ${vehicle.task}
      </div>
      <div class="vehicle-info">
        <strong>ìœ„ì¹˜:</strong> ${vehicle.lat.toFixed(6)}, ${vehicle.lng.toFixed(6)}
      </div>
      <div class="vehicle-info">
        <strong>ì •í™•ë„:</strong> ${vehicle.accuracy ? Math.round(vehicle.accuracy) + 'm' : '-'}
      </div>
      <div class="vehicle-info">
        <strong>ì‹œê°„:</strong> ${new Date(vehicle.timestamp).toLocaleString('ko-KR')}
      </div>
    `;
    
    listContainer.appendChild(item);
  });
}

// ì§€ë„ ë§ˆì»¤ ì—…ë°ì´íŠ¸
function updateMapMarkers() {
  if (!map) return;
  
  // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
  Object.values(markers).forEach(marker => marker.remove());
  markers = {};
  
  if (vehicleData.length === 0) {
    addDebugLog('âš ï¸ í‘œì‹œí•  ì°¨ëŸ‰ ì—†ìŒ');
    return;
  }
  
  // ìƒˆ ë§ˆì»¤ ì¶”ê°€
  vehicleData.forEach(vehicle => {
    const iconHtml = vehicle.isActive ? 'ğŸŸ¢' : 'ğŸ”´';
    
    const customIcon = L.divIcon({
      html: `<div style="font-size: 28px;">${iconHtml}</div>`,
      className: 'custom-marker',
      iconSize: [32, 32],
      iconAnchor: [16, 16]
    });
    
    const marker = L.marker([vehicle.lat, vehicle.lng], { icon: customIcon })
      .addTo(map);
    
    marker.bindPopup(`
      <div class="custom-popup">
        <div class="car-number">${vehicle.carNum}</div>
        <div class="info-item"><strong>ì—…ë¬´:</strong> ${vehicle.task}</div>
        <div class="info-item"><strong>ì •í™•ë„:</strong> ${vehicle.accuracy ? Math.round(vehicle.accuracy) + 'm' : '-'}</div>
        <div class="info-item"><strong>ì‹œê°„:</strong> ${new Date(vehicle.timestamp).toLocaleTimeString('ko-KR')}</div>
      </div>
    `);
    
    markers[vehicle.uid] = marker;
  });
  
  addDebugLog(`âœ… ${vehicleData.length}ê°œ ë§ˆì»¤ í‘œì‹œ ì™„ë£Œ`, 'success');
}

// íŠ¹ì • ì°¨ëŸ‰ì— í¬ì»¤ìŠ¤
function focusVehicle(vehicle) {
  if (!map || !markers[vehicle.uid]) return;
  
  map.setView([vehicle.lat, vehicle.lng], 16);
  markers[vehicle.uid].openPopup();
  
  addDebugLog(`ğŸ“ ${vehicle.carNum} ìœ„ì¹˜ë¡œ ì´ë™`);
}

// ëª¨ë“  ë§ˆì»¤ê°€ ë³´ì´ë„ë¡ ì¡°ì •
function fitAllMarkers() {
  if (!map || vehicleData.length === 0) {
    addDebugLog('âš ï¸ í‘œì‹œí•  ì°¨ëŸ‰ ì—†ìŒ');
    return;
  }
  
  const bounds = L.latLngBounds(
    vehicleData.map(v => [v.lat, v.lng])
  );
  
  map.fitBounds(bounds, { padding: [50, 50] });
  addDebugLog('ğŸ¯ ì „ì²´ ì°¨ëŸ‰ ë³´ê¸°');
}

// ë°ì´í„° ìƒˆë¡œê³ ì¹¨
function refreshData() {
  addDebugLog('ğŸ”„ ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨');
  location.reload();
}

// ì‚¬ì´ë“œë°” í† ê¸€
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const toggleBtn = document.getElementById('toggleSidebar');
  
  sidebar.classList.toggle('collapsed');
  toggleBtn.textContent = sidebar.classList.contains('collapsed') ? 'â–¶' : 'â—€';
  
  setTimeout(() => {
    if (map) map.invalidateSize();
  }, 300);
}
</script>

</body>
</html>
