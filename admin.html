<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ê´€ë¦¬ì íŒ¨ë„</title>
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:'Malgun Gothic',sans-serif }
    #map { height:100%; width:100%; position:absolute; top:0; left:0; z-index:0 }
    .panel {
      position:fixed;
      top:20px;
      right:20px;
      width:300px;
      background:#fff;
      border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.2);
      padding:16px;
      z-index:10;
      font-size:14px;
    }
    .panel h2 { margin-top:0; font-size:18px; color:#2c3e50 }
    .section { margin-bottom:16px }
    .section h4 { margin-bottom:6px; font-size:15px; color:#34495e }
    .status { background:#ecf0f1; padding:10px; border-radius:8px; color:#2c3e50; max-height:120px; overflow:auto }
    textarea { width:100%; height:60px; border-radius:8px; padding:8px; font-size:14px; margin-bottom:8px; border:1px solid #ccc }
    input[type="file"] { margin-bottom:8px }
    button {
      width:100%;
      padding:10px;
      font-weight:700;
      border:none;
      border-radius:8px;
      background:#2ecc71;
      color:#fff;
      cursor:pointer
    }
    img { max-width:100%; border-radius:8px; margin-top:6px }
    .clickable { cursor:pointer; margin-bottom:10px }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>
</head>
<body>
  <div id="map"></div>
  <div class="panel">
    <h2>ğŸ“‹ ê´€ë¦¬ì íŒ¨ë„</h2>

    <div class="section">
      <h4>ì ‘ì†ì ìœ„ì¹˜</h4>
      <div id="locationList" class="status">ë¡œë”© ì¤‘...</div>
    </div>

    <div class="section">
      <h4>ì „ì†¡ëœ íŒŒì¼/ì‚¬ì§„</h4>
      <div id="messageList" class="status">ë¡œë”© ì¤‘...</div>
    </div>

    <div class="section">
      <h4>ì „ë‹¬ì‚¬í•­ ì „ì†¡</h4>
      <textarea id="adminMemoInput" placeholder="ì „ë‹¬í•  ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      <input type="file" id="adminPhotoInput" accept="image/*" />
      <button id="sendMemoBtn">ì „ë‹¬ì‚¬í•­ ì „ì†¡</button>
    </div>
  </div>

  <script>
    const config = {
      apiKey: "AIzaSyBMcqlyHzCO0k6G-6Fzb7AHso2A3gGAbq8",
      authDomain: "car-location-tracker-438f0.firebaseapp.com",
      projectId: "car-location-tracker-438f0",
      storageBucket: "car-location-tracker-438f0.firebasestorage.app",
      messagingSenderId: "645185980587",
      appId: "1:645185980587:web:f2b54d5df01cb14d300fee",
      measurementId: "G-B0BG1K096R"
    };
    firebase.initializeApp(config);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    const map = L.map('map').setView([36.5, 127.8], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    const markers = {};

    auth.signInAnonymously().then(() => {
      listenToLocations();
      listenToMessages();
    });

    function listenToLocations() {
      db.ref('locations').on('value', snap => {
        const data = snap.val() || {};
        const list = document.getElementById('locationList');
        list.innerHTML = '';

        Object.entries(data).forEach(([uid, loc]) => {
          const { lat, lng, carNum, time } = loc;
          const info = `
            <strong>${carNum || 'ë¯¸ë“±ë¡ ì°¨ëŸ‰'}</strong><br/>
            ìœ„ë„: ${lat.toFixed(5)}, ê²½ë„: ${lng.toFixed(5)}<br/>
            ì‹œê°„: ${new Date(time).toLocaleString()}
          `;
          const div = document.createElement('div');
          div.className = 'clickable';
          div.innerHTML = info;
          div.onclick = () => map.setView([lat, lng], 14);
          list.appendChild(div);

          if (markers[uid]) {
            markers[uid].setLatLng([lat, lng]);
          } else {
            markers[uid] = L.marker([lat, lng]).addTo(map).bindPopup(info);
          }
        });

        if (Object.keys(data).length === 0) {
          list.textContent = 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ';
        }
      });
    }

    function listenToMessages() {
      db.ref('messages').on('value', snap => {
        const data = snap.val() || {};
        const list = document.getElementById('messageList');
        list.innerHTML = '';

        Object.entries(data).forEach(([uid, msgs]) => {
          Object.values(msgs).forEach(msg => {
            const div = document.createElement('div');
            div.style.marginBottom = '12px';
            if (msg.type === 'file') {
              div.innerHTML = `<strong>íŒŒì¼:</strong> <a href="${msg.url}" target="_blank">${msg.name}</a><br/>${new Date(msg.time).toLocaleString()}`;
            } else if (msg.type === 'photo') {
              div.innerHTML = `<strong>ì‚¬ì§„:</strong><br/><img src="${msg.url}" /><br/>${new Date(msg.time).toLocaleString()}`;
            }
            list.appendChild(div);
          });
        });

        if (Object.keys(data).length === 0) {
          list.textContent = 'ì „ì†¡ëœ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.';
        }
      });
    }

    document.getElementById('sendMemoBtn').addEventListener('click', async () => {
      const memo = document.getElementById('adminMemoInput').value.trim();
      const file = document.getElementById('adminPhotoInput').files[0];
      let photoUrl = '';

      if (file) {
        const ref = storage.ref(`admin/photos/${Date.now()}_${file.name}`);
        await ref.put(file);
        photoUrl = await ref.getDownloadURL();
      }

      await db.ref('adminDelivery').set({
        memo,
        photoUrl,
        time: Date.now()
      });

      alert("ì „ë‹¬ì‚¬í•­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
    });
  </script>
</body>
</html>